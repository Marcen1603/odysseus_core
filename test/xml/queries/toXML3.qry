#DROPALLQUERIES
#DROPALLSOURCES
#DROPALLSINKS
#PARSER PQL
#DEFINE filename toXML3
#ADDQUERY
input = ACCESS({
            source='source1',
            protocol='XML',
            transport='File',
            wrapper='GenericPull',
            datahandler='Tuple',
            options=[
              ['filename', '${BUNDLE-ROOT}/queries/document.xml'],
              ['nickname', '/users/user/nickname'],
              ['fname', '/users/user/fname'],
              ['lname', '/users/user/lname'],
              ['email', '/users/user/email'],
              ['role', '/users/user/roles/role'],
              ['age', '/users/user/age']
            ],
            schema=[
              ['nickname','String'],
              ['fname', 'String'],
              ['lname', 'String'],
              ['email', 'String'],
              ['role', 'String'],
              ['age', 'Integer']
            ]                                                                                                                                                        
          }                                                                                                                          
        )

inputXSD = ACCESS({
                source='toXmlExample2',
                protocol='SimpleCSV',
                transport='File',
                wrapper='GenericPull',
                datahandler='Tuple',
                options=[
                  ['filename', '${BUNDLE-ROOT}/queries/data2.csv']
                ],
                schema=[
                  ['xsd','String'],
                  ['root', 'String']
                ]                                                                                                                                             
              }                                                                                                                  
            )

transform1 = TOXML({
                  rootattribute = 'root',
                  xsdattribute = 'xsd'                           
                },
                JOIN(input, inputXSD
                )            
              )

transform2 = XMLTOTUPLE({
                  expressions = [
                    ['id', '/user/@id'],
                    ['nickname','/user/nickname'],
                    ['fname', '/user/fname'],
                    ['lname', '/user/lname'],
                    ['email', '/user/email'],
                    ['role1', '/user/roles/role[1]'],
                    ['role2', '/user/roles/role[2]'],
                    ['role3', '/user/roles/role[3]'],
                    ['age', '/user/age']
                  ],
                  schema = [
                    ['nickname','String'],
                    ['fname', 'String'],
                    ['lname', 'String'],
                    ['email', 'String'],
                    ['role', 'String'],
                    ['age', 'Integer']
                  ]                
                },
                transform1
              )
            