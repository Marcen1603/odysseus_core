#DROPALLQUERIES
#DROPALLSOURCES
#DROPALLSINKS
#PARSER PQL
#DEFINE filename toXML5
#ADDQUERY
input = ACCESS({
            source='source5',
            protocol='XML',
            transport='File',
            wrapper='GenericPull',
            datahandler='Tuple',
            options=[
              ['filename', '${BUNDLE-ROOT}/queries/document2.xml'],
              ['nickname', '/users/user/nickname'],
              ['fname', '/users/user/fname'],
              ['lname', '/users/user/lname'],
              ['email', '/users/user/email'],
              ['role', '/users/user/roles/role'],
              ['age', '/users/user/age'],
              ['user_id', '/users/user/@id'],
              ['role_1', '/users/user/roles/role[1]'],
              ['role_2', '/users/user/roles/role[2]'],
              ['role_3', '/users/user/roles/role[3]']
            ],
            schema=[
              ['nickname','String'],
              ['fname', 'String'],
              ['lname', 'String'],
              ['email', 'String'],
              ['role', 'String'],
              ['age', 'Integer'],
              ['user_id', 'Integer'],
              ['role_1', 'String'],
              ['role_2', 'String'],
              ['role_3', 'String']
            ]                                                                                                                                              
          }                                                                                                                  
        )

inputXPath = ACCESS({
                  source='toXmlExample2',
                  protocol='SimpleCSV',
                  transport='File',
                  wrapper='GenericPull',
                  datahandler='Tuple',
                  options=[
                  ['filename', '${BUNDLE-ROOT}/queries/data3.csv']
                  ],
                  schema=[
                    ['xpaths','String']
                  ]                                                                                                                             
                }                                                                                                                  
              )
 
transform1 = TOXML({
                rootelement = 'user',
                xpathattributes = ['xpaths'],
                xsdfile = '${BUNDLE-ROOT}/queries/schema2.xsd',
                options = [['delimeter', ';']]                                 
              },
              JOIN(input, inputXPath)
            )

transform2 = XMLTOTUPLE({
                  expressions = [
                  ['id', '/user/@id'],
                  ['nickname','/user/nickname'],
                  ['fname', '/user/fname'],
                  ['lname', '/user/lname'],
                  ['email', '/user/email'],
                  ['role1', '/user/roles/role[1]'],
                  ['role2', '/user/roles/role[2]'],
                  ['role3', '/user/roles/role[3]'],
                  ['age', '/user/age']
                  ],
                  schema = [
                  ['id', 'String'] ,             
                  ['nickname','String'],
                  ['fname', 'String'],
                  ['lname', 'String'],
                  ['email', 'String'],
                  ['role1', 'String'],
                  ['role2', 'String'],
                  ['role3', 'String'],
                  ['age', 'Integer']
                  ]
                },
                transform1
              )             
            