#DROPALLQUERIES
#DROPALLSOURCES
#DROPALLSINKS
#PARSER PQL
#DEFINE filename enrich
#ADDQUERY
/// if you use the root element as tag, nothing will be stripped
input = ACCESS({
            source='joinxmlexample8',
            protocol='XML3',
            transport='File',
            wrapper='GenericPull',
            datahandler='XMLStreamObject',
            options=[
              ['filename', '${BUNDLE-ROOT}/queries/toEnrich.xml'],
              ['tag_to_strip', 'user']
            ]                                                                                                                                                                                
          }                                                                                                                                                  
        )

enrichment = ACCESS({
                  source='enrichment',
                  protocol='XML3',
                  transport='File',
                  wrapper='GenericPull',
                  datahandler='XMLStreamObject',
                  options=[
                    ['filename', '${BUNDLE-ROOT}/queries/enrichment.xml'],
                    ['tag_to_strip', 'roles']
                  ]                                                                                                                                                                                      
                }                                                                                                                                                        
              )        
        
transform1 = XMLENRICH({
                  target = '/user',
                  predicate = 'true'///'/user/@id != /roles/@id'        
                },
                enrichment,
                input
              )        
     
transform2 = XMLTOTUPLE({
                  expressions = [
                    ['nickname','/user/nickname'],
                    ['fname', '/user/fname'],
                    ['lname', '/user/lname'],
                    ['email', '/user/email'],
                    ['role1', '/user/roles/role[1]'],
                    ['role2', '/user/roles/role[2]'],
                    ['role3', '/user/roles/role[3]'],
                    ['age', '/user/age']
                  ],
                  schema = [
                    ['nickname','String'],
                    ['fname', 'String'],
                    ['lname', 'String'],
                    ['email', 'String'],
                    ['role1', 'String'],
                    ['role2', 'String'],
                    ['role3', 'String'],
                    ['age', 'Integer']
                  ]                
                },
                transform1
              )
