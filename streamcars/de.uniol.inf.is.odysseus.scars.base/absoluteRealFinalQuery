#DEFINE brokerSourceName streamCarsBroker // QuellenName
#DEFINE brokerListName   streamCarsBroker.scan:cars // Attributname der Liste der Autos in der Brokerquelle

#DEFINE brokerSourceName2 streamCarsBroker2 // QuellenName
#DEFINE brokerListName2   streamCarsBroker2.scan:cars // Attributname der Liste der Autos in der Brokerquelle

#DEFINE sensorSource    ACCESS(radarSensor) // Quellenoperator(!) des Sensors
#DEFINE sensorListName  radarSensor.scan:cars // Attributname der Liste der Autos in der Sensorquelle

#DEFINE assoScanned     radarSensor.scan:scannedObjects
#DEFINE assoPedicted    radarSensor.scan:predictedObjects
#DEFINE assoSourceName  selectionSrc
#DEFINE assoSource      ASSOCIATION-SRC(selectionSrc, 0)
#DEFINE assoSourceName2 selectionSrc2
#DEFINE assoSource2     ASSOCIATION-SRC(selectionSrc2, 0)
#DEFINE assoAlgo1       MAHA // Welcher Algorithmus zur Assoziation wird verwendet?
#DEFINE assoAlgo2       MULTIDISTANCE // Welcher Algorithmus zur Assoziation wird verwendet?

#DEFINE filterAlgo      KALMAN // Welcher Filterungsalgorithmus wird verwendet?

#PARSER PQLHack
#TRANSCFG StreamCars
#CYCLICQUERY
LOGICAL PLAN : 
BROKER(${brokerSourceName}, // Pfad f端r das Initialisieren des Brokers mit Startdaten (muss noch ein Select rein)
    SET-PREDICTION-OR(
        BROKER-INIT(
            ${sensorSource},
            3
        ),
        ${sensorListName},
        ${sensorListName}:car:posx := ${sensorListName}:car:posx * 2 ;
        WHERE ${sensorListName}:car:id >= 50;
        DEFAULT ${sensorListName}:car:posx := ${sensorListName}:car:posx;
    )
);

BROKER(${brokerSourceName2}, // Pfad f端r das Initialisieren des Brokers mit Startdaten (muss noch ein Select rein)
    SET-PREDICTION-OR(
        BROKER-INIT(
            ${sensorSource},
            3
        ),
        ${sensorListName},
        ${sensorListName}:car:posx := ${sensorListName}:car:posx * 2 ;
        WHERE ${sensorListName}:car:id >= 50;
        DEFAULT ${sensorListName}:car:posx := ${sensorListName}:car:posx;
    )
);

ASSOCIATION-SEL(
    ASSOCIATION-EVAL (
        ASSOCIATION-EVAL (
            ASSOCIATION-GEN (
                 SET-PREDICTION-OR(
                        BUFFER(
                            ${sensorSource},
                            Normal
                        ),
                        ${sensorListName},
                        ${sensorListName}:car:posx := ${sensorListName}:car:posx * 2 ;
                        WHERE ${sensorListName}:car:id >= 50;
                        DEFAULT ${sensorListName}:car:posx := ${sensorListName}:car:posx;
                 ),
                 PREDICTION(
                    ${sensorSource}, // Timestamp aus Sensor
                    BUFFER(
                        BROKER(${brokerSourceName}, // Brokerdaten 
                                QUEUE( // Zeitgeber f端r den Broker
                                       ${sensorSource}
                                )
                        ),
                        Normal 
                    ),
                    ${brokerListName}
                 ),
                 ${sensorListName},
                 ${brokerListName}
            ),
            ${assoAlgo1},
            threshold := 5; operator := LESSEQUAL;,
            ${assoScanned},
            ${assoPedicted}
        ),
        ${assoAlgo2},
        distanceFunction := EUCLIDEAN;,
        ${assoScanned},
        ${assoPedicted}
    ),
    ${assoSourceName},
    ${assoScanned},
    ${assoPedicted}
);

BROKER( 
    ${brokerSourceName}, 
    EVALUATE(
        ASSOCIATION-SRC(
            ${assoSourceName},
            2
        ),
        ${assoPedicted},
        FILTER-ESTIMATE(
            FILTER-COVARIANCE(
                FILTER-GAIN(
                    ASSOCIATION-SRC(
                        ${assoSourceName},
                        1
                    ),
                    ${filterAlgo}
                ),
                ${filterAlgo}
            ),
            ${assoScanned},
            ${assoPedicted},
            ${filterAlgo}
        ),
        ${assoPedicted},
        BROKER( ${brokerSourceName2}),
        
        
        //FILTER-GAIN(
        //    ${assoSource},
        //    ${filterAlgo}
        //),
        ${assoScanned},
        5
    )
);

ASSOCIATION-SEL(
    ASSOCIATION-EVAL (
        ASSOCIATION-EVAL (
		    ASSOCIATION-GEN (
		        BUFFER(
		            ${assoSource},
		            Normal
		        ),
		         PREDICTION(
		            ${assoSource}, // Timestamp aus Sensor
		            BUFFER(
		                BROKER(${brokerSourceName2}, // Brokerdaten 
		                        QUEUE( // Zeitgeber f端r den Broker
		                               ${assoSource}
		                        )
		                ),
		                Normal 
		            ),
		            ${brokerListName2}
		         ),
		         ${assoScanned},
		         ${brokerListName2}
		    ),
            ${assoAlgo1},
            threshold := 5; operator := LESSEQUAL;,
            ${assoScanned},
            ${assoPedicted}
        ),
        ${assoAlgo2},
        distanceFunction := EUCLIDEAN;,
        ${assoScanned},
        ${assoPedicted}
    ),
    ${assoSourceName2},
    ${assoScanned},
    ${assoPedicted}
);

BROKER( 
    ${brokerSourceName2}, 
    EVALUATE(
        ASSOCIATION-SRC(
            ${assoSourceName2},
            2
        ),
        ${assoPedicted},
        FILTER-ESTIMATE(
            FILTER-COVARIANCE(
                FILTER-GAIN(
                    ASSOCIATION-SRC(
                        ${assoSourceName2},
                        1
                    ),
                    ${filterAlgo}
                ),
                ${filterAlgo}
            ),
            ${assoScanned},
            ${assoPedicted},
            ${filterAlgo}
        ),
        ${assoPedicted},
        ASSOCIATION-SRC(
            ${assoSourceName2},
            0
        ),
        ${assoScanned},
        5
    )
);
