/*
 * generated by Xtext 2.10.0
 */
package de.uniol.inf.is.odysseus.parser.novel.cql.tests

import com.google.inject.Inject
import de.uniol.inf.is.odysseus.parser.novel.cql.cQL.Model
import de.uniol.inf.is.odysseus.parser.novel.cql.generator.CQLGenerator
import java.util.Collection
import org.eclipse.xtext.generator.InMemoryFileSystemAccess
import org.eclipse.xtext.junit4.InjectWith
import org.eclipse.xtext.junit4.XtextRunner
import org.eclipse.xtext.junit4.util.ParseHelper
import org.junit.Test
import org.junit.runner.RunWith

import static extension org.junit.Assert.*
import de.uniol.inf.is.odysseus.core.sdf.schema.SDFSchema
import java.util.Set
import de.uniol.inf.is.odysseus.parser.novel.cql.validation.CQLValidator
import org.eclipse.xtext.junit4.validation.ValidationTestHelper
import org.eclipse.xtext.validation.Issue
import java.util.ArrayList

@RunWith(XtextRunner)
@InjectWith(CQLInjectorProvider)
class CQLParserTest
{

	@Inject extension ValidationTestHelper
	@Inject extension CQLGenerator
	@Inject extension ParseHelper<Model>
	@Inject CQLDictionaryDummy dictionary
	
	@Test def void SelectAllTest1() 
	{ 
		assertCorrectGenerated
		(
			"SELECT * FROM stream1;" 
			,
			"ACCESS
			(
				{
					source      = 'Source'
					wrapper     = 'GenericPush'
					transport   = 'TCPClient'
					dataHandler = 'Tuple'
					schema = 
					[
						['attr1', 'Integer'],
						['attr2', 'String']
					]
				}
			)"
		)
	}

	@Test def void SelectAllTest2() 
	{ 
		assertCorrectGenerated
		(
			"SELECT * FROM stream1 WHERE (attr1 < 125);" 
			,
			"SELECT
			(
				{ predicate=(attr1 < 125) }, 
			
				ACCESS
				(
					{ 
						source      = 'Source'
						wrapper     = 'GenericPush'
						transport   = 'TCPClient'
						dataHandler = 'Tuple'
						schema = 
						[
							['attr1', 'Integer'],
							['attr2', 'String']	
						]
					}
				)
 			)"
		)
	}
	
	@Test def void SelectAttr1Attr2() 
	{ 
		assertCorrectGenerated
		(
			"SELECT attr1, attr2 FROM stream1 WHERE (attr1 < 125);" 
			,
			"SELECT
			(
				{ predicate=(attr1 < 125) }, 
			
				ACCESS
				(
					{ 
						source      = 'Source'
						wrapper     = 'GenericPush'
						transport   = 'TCPClient'
						dataHandler = 'Tuple'
						schema = 
						[
							['attr1', 'Integer'],
							['attr2', 'String']	
						]
					}
				)
 			)"
		)
	}
	
	def void assertCorrectGenerated(String s, String t) 
	{
		
		s.parse.assertNoErrors
		var model = s.parse 
		val fsa = new InMemoryFileSystemAccess()
		schema = dictionary.schema as Set<SDFSchema>
        doGenerate(model.eResource(), fsa, null)
        var query = ''
		for(e : fsa.textFiles.entrySet)
		{
			query += e.value
		}
//		println("result: " + query)
		format(t).assertEquals(format(query))
	} 
	
	//TODO \t should also be removed
	//TODO ecspace symbols should retrived with System.getProperties(linesperator)
	def String format(String s) { s.replaceAll("\\s*[\\r\\n]+\\s*", "").trim().replace(" ","") }
	
}
